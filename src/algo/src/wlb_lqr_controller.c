#include "wlb_lqr_controller.h"
#include <stdint.h>
#include <math.h>
#include "robot.h"
#define LQR11 (-9.0381f)
#define LQR12 (-0.8002f)
#define LQR13 (-1.5454f)
#define LQR14 (-1.8952f)
#define LQR15 (7.0606f)
#define LQR16 (0.8181f)
#define LQR21 (29.8781f)
#define LQR22 (3.7447f)
#define LQR23 (11.3292f)
#define LQR24 (12.9867f)
#define LQR25 (25.9207f)
#define LQR26 (0.8019f)

#define OPENSOURCE_COORDINATE
//    Q=diag([0.1 0.1 100 50 5000 1]);
//    R=diag([150 5]);  
// float lqr_poly_fit_param[12][4] = 
// {{-146.8397,178.1973,-83.7881,2.8443},
// {8.5304,-3.7974,-3.5802,0.2173},
// {-40.5217,39.2950,-13.5266,0.9230},
// {-57.9757,56.6803,-19.9446,1.3387},
// {195.0357,-122.9509,9.7593,6.2244},
// {28.3143,-20.0813,3.1549,0.5661},
// {1473.2038,-1142.9067,247.5109,5.8574},
// {105.5269,-94.7226,27.2942,-0.5018},
// {135.5466,-83.0411,4.9135,4.6654},
// {206.4120,-129.2789,9.6747,6.7037},
// {1603.1755,-1567.6944,545.5435,-38.7507},
// {130.3261,-137.4586,52.2075,-5.0431}};

// Q=diag([0.1 0.1 100 50 5000 1]);
// R=[150 0;0 5];
// float lqr_poly_fit_param[12][4] = 
// {{-135.3453,158.9821,-75.0086,2.0930},
// {4.8803,-1.4456,-3.8973,0.1909},
// {-37.5561,35.2304,-11.7066,0.6412},
// {-54.4328,51.3769,-17.4431,0.9291},
// {138.9470,-77.9373,-2.4892,7.9823},
// {21.5725,-14.9521,2.0154,0.6933},
// {1117.0967,-875.1741,193.5456,7.1032},
// {85.3890,-76.2583,21.8655,-0.1857},
// {65.3828,-28.1241,-8.2274,5.3604},
// {103.0676,-47.8553,-10.0767,7.8005},
// {1622.2835,-1555.2473,533.1584,-34.9396},
// {129.6584,-132.4556,49.3328,-4.6592}};


//    Q=diag([0.1 0.1 100 500 5000 1]);
//    R=[150 0;0 5];
// float lqr_poly_fit_param[12][4] = 
// {{-75.0118,112.1647,-70.4753,1.8061},
// {12.9513,-8.7708,-3.6872,0.1924},
// {-26.5521,26.3310,-9.4944,0.5264},
// {-68.3177,68.2261,-25.1308,1.3668},
// {130.5731,-82.6278,3.4079,7.5875},
// {18.2980,-13.4825,2.1852,0.6954},
// {1191.5062,-1006.2760,259.2660,5.5796},
// {96.2733,-95.5380,33.4083,-0.3565},
// {65.3363,-35.3815,-3.4411,4.9918},
// {179.6229,-101.0996,-6.1644,13.0344},
// {1158.9919,-1180.8042,442.3189,-31.6758},
// {93.3741,-102.2150,41.9548,-4.6102}};


//    Q=diag([0.1 0.1 100 1600 5000 1]);
//    R=[100 0;0 5];

extern Robot_State_t g_robot_state;
float lqr_poly_fit_param[12][4] = 
{{-40.4426,92.2805,-83.0307,1.9406},
{22.7498,-17.8524,-5.2327,0.2516},
{-25.5025,25.6231,-9.5258,0.4409+1.0f},
{-106.6486,107.8056,-40.8232,1.8520},
{115.6430,-73.3241,0.9146,9.4114},
{16.9954,-12.9700,2.2799,0.8896},
{1188.7971,-1067.5053,309.3857,5.7028},
{104.6622,-112.2293,45.3611,-0.3419},
{42.0172,-20.5095,-5.3839,4.9969},
{187.4530,-96.2940,-19.6252,21.2350},
{942.3723,-975.0634,379.1022,-27.2181},
{80.8579,-89.0861,37.8765,-4.6313}};


// {{-205.9340,182.4261,-81.6013,-2.0630},
// {-4.0351,3.0252,-9.4435,0.1174},
// {-17.8698,13.3643,-3.4224,-0.6853},
// {-75.6744,57.1525,-15.3750,-2.8223},
// {-234.5798,191.8151,-57.7961,7.9388},
// {-12.1492,10.1305,-3.1450,0.5385},
// {-120.1702,130.4549,-58.2512,18.2814},
// {21.1454,-15.6574,3.7942,1.0837},
// {-136.4653,110.4869,-32.6252,4.1425},
// {-558.1383,452.4317,-133.9465,17.1937},
// {737.0973,-556.4398,145.0014,19.3772},
// {56.9856,-43.7762,11.7950,0.2071}};

// {{-185.9303,167.0137,-77.5052,-1.5654},
// {-3.2532,2.3636,-9.2167,0.1093},
// {-16.0410,11.9739,-3.0571,-0.7204},
// {-68.0619,51.3700,-13.8595,-2.9649},
// {-223.9978,182.4823,-54.6638,7.4469},
// {-9.9488,8.3139,-2.5908,0.4628},
// {-107.1351,116.3386,-52.0359,15.7367},
// {18.1150,-13.3660,3.2206,0.9935},
// {-132.8212,107.1330,-31.4378,3.9437},
// {-542.4699,438.0650,-128.8755,16.3386},
// {654.3838,-493.0861,128.0963,20.2368},
// {48.0822,-36.9396,9.9531,0.0150}};

// {{-189.0658,169.6434,-82.6614,-1.4751},
// {-2.4117,0.7559,-9.6355,0.1219},
// {-52.3378,39.0928,-9.9916,-2.2465},
// {-78.6660,60.5445,-17.8265,-3.1014},
// {-224.6587,183.2522,-55.0089,7.5690},
// {-9.8484,8.2483,-2.5706,0.4729},
// {-93.9751,106.9596,-50.0216,16.3929},
// {20.2443,-15.1916,3.9384,1.0240},
// {-423.0503,341.5971,-100.4265,12.6507},
// {-570.3548,462.1715,-136.9180,17.7981},
// {676.5543,-510.2762,132.7894,19.7376},
// {49.9542,-38.4243,10.3764,-0.0364}};

// {{-214.4369,192.1422,-93.2637,-1.4090},
// {-2.8310,0.9267,-10.8075,0.1500},
// {-66.2022,49.4913,-12.6657,-2.4422},
// {-96.9598,74.5361,-21.7641,-3.3074},
// {-231.2971,189.3706,-57.1827,7.9705},
// {-9.9426,8.3908,-2.6435,0.5026},
// {-90.9128,110.8634,-54.8607,18.8002},
// {25.3090,-19.0486,4.9857,1.1705},
// {-499.1131,404.0542,-119.2520,15.1210},
// {-659.0234,535.5100,-159.3205,20.8687},
// {756.1795,-571.0452,148.8974,18.1456},
// {56.5955,-43.5863,11.7921,-0.1894}};

// {{-390.9732,345.6023,-157.5780,-0.1152},
// {-7.6662,4.5979,-17.6171,0.3817},
// {-161.7810,121.4266,-31.2475,-1.9038},
// {-264.8276,201.6413,-55.5333,-3.0169},
// {-200.6764,170.2383,-54.2243,8.3679},
// {-7.2560,6.7557,-2.4148,0.5966},
// {10.9650,81.6354,-76.0720,34.1730},
// {68.5742,-51.5749,13.3616,2.0595},
// {-787.0193,650.2566,-197.5825,26.1145},
// {-1210.3059,1004.0606,-307.5440,41.8513},
// {1144.2013,-870.3319,229.4692,2.8618},
// {97.0347,-75.2897,20.5907,-1.2532}};

// {{-374.8756,331.7781,-147.7309,1.0628},
// {-6.8573,4.6111,-15.8647,0.4311},
// {-169.1987,128.1212,-33.4186,-1.0419},
// {-276.3509,211.9035,-58.5229,-1.6077},
// {-202.9786,176.9146,-58.4212,9.3453},
// {-4.5244,4.6905,-1.8783,0.5231},
// {435.3883,-176.2513,-48.6391,52.6061},
// {152.3392,-116.5317,31.3821,2.9173},
// {-1047.7343,887.8103,-279.9796,39.3492},
// {-1594.5422,1360.0519,-433.9683,63.3174},
// {2285.4195,-1749.8911,465.7112,-0.6387},
// {158.2937,-123.8676,34.3126,-2.4652}};
void LQR_Output(lqr_u_t *u, lqr_ss_t *state)
{
float len = state->leg_len;
float len_sqrt = len * len;
float len_cub = len * len * len;
if (g_robot_state.spintop_mode){
    u->T_A = (lqr_poly_fit_param[0 ][0] * len_cub + lqr_poly_fit_param[0 ][1] * len_sqrt + lqr_poly_fit_param[0 ][2] * len + lqr_poly_fit_param[0 ][3]) * -state->theta +
             (lqr_poly_fit_param[1 ][0] * len_cub + lqr_poly_fit_param[1 ][1] * len_sqrt + lqr_poly_fit_param[1 ][2] * len + lqr_poly_fit_param[1 ][3]) * -state->theta_dot +
             (lqr_poly_fit_param[2 ][0] * len_cub + lqr_poly_fit_param[2 ][1] * len_sqrt + lqr_poly_fit_param[2 ][2] * len + lqr_poly_fit_param[2 ][3]) * (state->target_x-state->x) * 0 +
             (lqr_poly_fit_param[3 ][0] * len_cub + lqr_poly_fit_param[3 ][1] * len_sqrt + lqr_poly_fit_param[3 ][2] * len + lqr_poly_fit_param[3 ][3]) * (state->target_x_dot - state->x_dot) +
             (lqr_poly_fit_param[4 ][0] * len_cub + lqr_poly_fit_param[4 ][1] * len_sqrt + lqr_poly_fit_param[4 ][2] * len + lqr_poly_fit_param[4 ][3]) * (-state->phi) +
             (lqr_poly_fit_param[5 ][0] * len_cub + lqr_poly_fit_param[5 ][1] * len_sqrt + lqr_poly_fit_param[5 ][2] * len + lqr_poly_fit_param[5 ][3]) * -state->phi_dot;
    u->T_B = (lqr_poly_fit_param[6 ][0] * len_cub + lqr_poly_fit_param[6 ][1] * len_sqrt + lqr_poly_fit_param[6 ][2] * len + lqr_poly_fit_param[6 ][3]) * -state->theta +
             (lqr_poly_fit_param[7 ][0] * len_cub + lqr_poly_fit_param[7 ][1] * len_sqrt + lqr_poly_fit_param[7 ][2] * len + lqr_poly_fit_param[7 ][3]) * -state->theta_dot +
             (lqr_poly_fit_param[8 ][0] * len_cub + lqr_poly_fit_param[8 ][1] * len_sqrt + lqr_poly_fit_param[8 ][2] * len + lqr_poly_fit_param[8 ][3]) * (state->target_x-state->x) * 0+
             (lqr_poly_fit_param[9 ][0] * len_cub + lqr_poly_fit_param[9 ][1] * len_sqrt + lqr_poly_fit_param[9 ][2] * len + lqr_poly_fit_param[9 ][3]) * (state->target_x_dot-state->x_dot) +
             (lqr_poly_fit_param[10][0] * len_cub + lqr_poly_fit_param[10][1] * len_sqrt + lqr_poly_fit_param[10][2] * len + lqr_poly_fit_param[10][3]) * (-state->phi) +
             (lqr_poly_fit_param[11][0] * len_cub + lqr_poly_fit_param[11][1] * len_sqrt + lqr_poly_fit_param[11][2] * len + lqr_poly_fit_param[11][3]) * -state->phi_dot;

}
else
{
    u->T_A = (lqr_poly_fit_param[0 ][0] * len_cub + lqr_poly_fit_param[0 ][1] * len_sqrt + lqr_poly_fit_param[0 ][2] * len + lqr_poly_fit_param[0 ][3]) * -state->theta +
             (lqr_poly_fit_param[1 ][0] * len_cub + lqr_poly_fit_param[1 ][1] * len_sqrt + lqr_poly_fit_param[1 ][2] * len + lqr_poly_fit_param[1 ][3]) * -state->theta_dot +
             (lqr_poly_fit_param[2 ][0] * len_cub + lqr_poly_fit_param[2 ][1] * len_sqrt + lqr_poly_fit_param[2 ][2] * len + lqr_poly_fit_param[2 ][3]) * (state->target_x-state->x) +
             (lqr_poly_fit_param[3 ][0] * len_cub + lqr_poly_fit_param[3 ][1] * len_sqrt + lqr_poly_fit_param[3 ][2] * len + lqr_poly_fit_param[3 ][3]) * (state->target_x_dot - state->x_dot) +
             (lqr_poly_fit_param[4 ][0] * len_cub + lqr_poly_fit_param[4 ][1] * len_sqrt + lqr_poly_fit_param[4 ][2] * len + lqr_poly_fit_param[4 ][3]) * (-state->phi) +
             (lqr_poly_fit_param[5 ][0] * len_cub + lqr_poly_fit_param[5 ][1] * len_sqrt + lqr_poly_fit_param[5 ][2] * len + lqr_poly_fit_param[5 ][3]) * -state->phi_dot;
    u->T_B = (lqr_poly_fit_param[6 ][0] * len_cub + lqr_poly_fit_param[6 ][1] * len_sqrt + lqr_poly_fit_param[6 ][2] * len + lqr_poly_fit_param[6 ][3]) * -state->theta +
             (lqr_poly_fit_param[7 ][0] * len_cub + lqr_poly_fit_param[7 ][1] * len_sqrt + lqr_poly_fit_param[7 ][2] * len + lqr_poly_fit_param[7 ][3]) * -state->theta_dot +
             (lqr_poly_fit_param[8 ][0] * len_cub + lqr_poly_fit_param[8 ][1] * len_sqrt + lqr_poly_fit_param[8 ][2] * len + lqr_poly_fit_param[8 ][3]) * (state->target_x-state->x) +
             (lqr_poly_fit_param[9 ][0] * len_cub + lqr_poly_fit_param[9 ][1] * len_sqrt + lqr_poly_fit_param[9 ][2] * len + lqr_poly_fit_param[9 ][3]) * (state->target_x_dot-state->x_dot) +
             (lqr_poly_fit_param[10][0] * len_cub + lqr_poly_fit_param[10][1] * len_sqrt + lqr_poly_fit_param[10][2] * len + lqr_poly_fit_param[10][3]) * (-state->phi) +
             (lqr_poly_fit_param[11][0] * len_cub + lqr_poly_fit_param[11][1] * len_sqrt + lqr_poly_fit_param[11][2] * len + lqr_poly_fit_param[11][3]) * -state->phi_dot;
}
}
